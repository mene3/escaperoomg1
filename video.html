<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>V칤deo remoto sincronizado</title>
</head>
<body>
  <p id="status">Pulsa el bot칩n para preparar el v칤deo</p>

  <button id="prepareBtn"
    style="padding:12px 24px; font-size:16px; margin:20px; border:none; border-radius:8px; cursor:pointer;">
    游꿟 Preparar v칤deo
  </button>

  <br>

  <video id="video" width="640" controls playsinline>
    Tu navegador no soporta v칤deo HTML5.
  </video>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // --- Configuraci칩n Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAwRuRAEiszBLwDajaDG51AI4HjMSe2Lh4",
      authDomain: "escape-room-g1.firebaseapp.com",
      databaseURL: "https://escape-room-g1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "escape-room-g1",
      storageBucket: "escape-room-g1.firebasestorage.app",
      messagingSenderId: "652279185289",
      appId: "1:652279185289:web:ba75116458fdf92c092b58"
    };

    // --- Inicializa Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const video = document.getElementById("video");
    const btn = document.getElementById("prepareBtn");
    const status = document.getElementById("status");

    let interactionAllowed = false;
    let pendingVideo = null;

    // --- Escucha el trigger remoto ---
    const triggerRef = ref(db, "trigger");
    onValue(triggerRef, (snapshot) => {
      const data = snapshot.val();
      if (data && data.video) {
        pendingVideo = data.video;
        console.log("游꿢 Se침al remota detectada:", pendingVideo);
        // Si ya se prepar칩 la interacci칩n, reproduce de inmediato
        if (interactionAllowed) playPendingVideo();
      }
    });

    // --- Al hacer clic el usuario ---
    btn.addEventListener("click", async () => {
      try {
        interactionAllowed = true;
        btn.style.display = "none";
        status.textContent = "Esperando se침al del QR...";

        if (pendingVideo) {
          // Carga el v칤deo real para obtener permiso de reproducci칩n
          video.src = `${pendingVideo}.mp4`;
          video.muted = true;
          await video.play();
          video.pause();
          video.muted = false;
          console.log("游꿟 Interacci칩n registrada para", pendingVideo);
        } else {
          console.log("Esperando se침al remota...");
        }
      } catch (err) {
        console.error("Error preparando video:", err);
      }
    });

    // --- Funci칩n para reproducir cuando llegue el trigger ---
    async function playPendingVideo() {
      if (!pendingVideo) return;
      try {
        video.src = `${pendingVideo}.mp4`;
        video.currentTime = 0;
        video.muted = false;
        await video.play();
        status.textContent = "";
        console.log("郊윒잺 Reproduciendo:", pendingVideo);
      } catch (err) {
        console.error("Playback bloqueado:", err);
      }
    }

    // --- Limpia trigger al terminar ---
    video.addEventListener("ended", async () => {
      await set(triggerRef, null);
      console.log("游빛 Trigger limpiado tras finalizar v칤deo.");
    });
  </script>
</body>
</html>
